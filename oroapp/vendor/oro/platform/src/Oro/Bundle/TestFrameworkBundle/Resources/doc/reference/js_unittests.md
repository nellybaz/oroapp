# JavaScript UnitTests

## Installation
For running JS tests following software required:
 - **[Node.js]** (JavaScript Engine)
 - **[Karma]** (Test Runner for JavaScript)
 - **[Jasmine 2]** (Behavior-Driven Development Testing Framework)

How to install **Node.js** you can find on [official website](https://nodejs.org/en/download/). 
After `node` is installed, you need to install several modules using **[Node Packaged Modules](https://npmjs.org/)** manager.
To do so, just execute following command from the root folder of your application:

```bash
npm install --prefix=vendor/oro/platform/build
```
Where `--prefix` parameter specifies relative path to `platform/build` directory.

This way installation will work per project.

But you might want to install all required modules globally to reuse the setup between projects, then execute `npm install -g <package>` for each module defined in `package.json`.
Just keep in mind, **Karma** module and all plugins have to be installed on same level (all globally or all locally).

## Configuration
Configuration for tests-run is placed in `build/karma.config.js.dist` (see [Karma documentation]).

Paths used in configuratin:
- `web/js/require-config.js` main requirejs config (is generated by application durring `oro:requirejs:build`);
- `**/Karma/main.js` main entry point of **Karma**;
- `**/Karma/lib/**/require-config.js` configurations for test frameworks;
- `**/Karma/lib/**/*.js` 3d-party libs required for test, such as [Jasmine-jQuery];
- `**/Tests/JS/Fixture/**/*` fixtures fot test, such as html and json files;
- `web/bundles/**/*.js` all public javascript files (by default are not included in page, due to that we use **RequireJS**);
- `**/Tests/JS/**/*Spec.js` tests files (in terms of **Karma** they are specs).

## Running
To run test call command
```bash
./vendor/oro/platform/build/node_modules/.bin/karma start ./vendor/oro/platform/build/karma.conf.js.dist --single-run
```

Or if you have **Karma** installed globally:
```bash
karma start ./vendor/oro/platform/build/karma.conf.js.dist --single-run
```

Don't forget to change the path to `platform/build` directory, if it is different in your application.

To run testsuite with custom configuration, you might find useful command line parameters which overwrites parameters in configuration file (see [documentation][Karma documentation]).
But usually it's better to create own configuration file, just copy `./vendor/oro/platform/build/karma.config.js.dist` file to `./vendor/oro/platform/build/karma.config.js` and modify it.

For developer which use **PHPStorm** will be usefull couple extensions:
- **[Karma plugin]** helps to run testsuite from IDE and see result there; 
- **[ddescriber for jasmine]** helps quickly turn off or skip some tests from testsuite.

## Writing
How to write tests with **Jasmine 2** see [documentation][Jasmine 2].
Here's just trivial case, that's how look spec for `oroui/js/mediator` module:
```js
define(['oroui/js/mediator', 'backbone'],
function(mediator, Backbone) {
    'use strict';

    describe('oroui/js/mediator', function () {
        it("compare mediator to Backbone.Events", function() {
            expect(mediator).toEqual(Backbone.Events);
            expect(mediator).not.toBe(Backbone.Events);
        });
    });
});
```
First, in define section required modules are loaded. And then, inside tree of `describe()` and `it()` calls specified tests assertions.

### karma-requirejs-exposure
This approach allows to test public API of a module. But what about mocking depended on modules and internal module's functional.

Here comes **[karma-requirejs-exposure]** plugin. This **Karma**'s plugin on a fly injects exposing code inside requirejs module and provides API to manipulate internal variables.

See example how it works:
```js
define(function(require) {
    'use strict';
    var someModule = require('some/module');
    var requirejsExposure = require('requirejs-exposure');

    // get exposure instance for tested module
    var exposure = requirejsExposure.disclose('some/module');

    describe('some/module', function () {
        var foo;
        // save original value of foo variable
        exposure.backup('foo');

        beforeEach(function () {
            // create mock object with stub method 'do'
            foo = jasmine.createSpyObj('foo', ['do']);
            // before each test, pass it off instead of original
            exposure.substitute('foo').by(foo);
        });
        afterEach(function () {
            // after each test restore original value of foo
            exposure.recover('foo');
        });

        it('check doSomething() method', function() {
            // private foo object is successfully replaced by the mock
            expect(exposure.retrieve('foo')).toBe(foo);
            // mean time, original object is safe
            expect(exposure.retrieve('foo')).not.toBe(exposure.original('foo'));

            someModule.doSomething();

            // stub method of mock object has been called
            expect(foo.do).toHaveBeenCalled();
            // this is the same as previous assertion
            expect(exposure.retrieve('foo').do).toHaveBeenCalled();
        });
    });
});
```

### Jasmine-jQuery
[Jasmine-jQuery] extends base functionality of Jasmine:

 - adds bunch of useful matchers, allows to easily check state of a jQuery instance;
 - provides the way for loading HTML and JSON fixtures required for a test;
 - applies HTML-fixtures before each test and rolls back the document after tests.

Due to `Jasmine-jQuery` requires full path to a fixture resource, it's better use `requirejs` to perform loading fixtures by related path.

```js
define(function(require) {
    var $ = require('jquery');
    var html = require('text!./Fixture/markup.html');

    describe('some/module', function () {
        beforeEach(function () {
            // appends loaded html to document's body,
            // after test rolls back it automatically
            window.setFixtures(html);
        });

        it('checks the markup of a page', function () {
            expect($('li')).toHaveLength(5);
        });
    });
});
```

[Node.js]: <http://nodejs.org/>
[Karma]: <http://karma-runner.github.io/0.13/index.html>
[Karma documentation]: <http://karma-runner.github.io/0.13/config/configuration-file.html>
[Jasmine 2]: <https://jasmine.github.io/2.5/introduction.html>
[Jasmine-jQuery]: <https://github.com/velesin/jasmine-jquery>
[karma-requirejs-exposure]: <https://github.com/laboro/karma-requirejs-exposure.git>
[Karma plugin]: <https://plugins.jetbrains.com/plugin/7287-karma>
[ddescriber for jasmine]: <https://plugins.jetbrains.com/plugin/7233-ddescriber-for-jasmine>
